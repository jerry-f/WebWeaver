generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model Source {
  id            String   @id @default(cuid())
  name          String
  type          String   // rss, api, scrape
  url           String
  category      String?  // 分类：tech, ai, frontend, backend, investment 等
  config        String?  // JSON config for API keys, selectors, etc.
  enabled       Boolean  @default(true)
  fetchFullText Boolean  @default(false)  // 是否抓取全文
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  articles      Article[]
  subscriptions Subscription[]
}

model Article {
  id            String   @id @default(cuid())
  sourceId      String
  source        Source   @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  externalId    String?  // Original ID from source
  title         String
  content       String?
  summary       String?
  url           String
  imageUrl      String?
  author        String?
  publishedAt   DateTime?
  fetchedAt     DateTime @default(now())
  read          Boolean  @default(false)
  starred       Boolean  @default(false)
  tags          String?  // JSON: ["tech", "ai"]
  category      String?  // 分类
  readingTime   Int?     // 阅读时间（分钟）
  summaryStatus String   @default("pending")  // pending/processing/completed/failed
  readHistory   ReadHistory[]
  bookmarks     Bookmark[]

  @@unique([sourceId, externalId])
  @@index([publishedAt])
  @@index([read])
  @@index([summaryStatus])
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  password      String
  name          String?
  role          String   @default("user")  // user, admin
  emailVerified Boolean  @default(false)   // 邮箱是否验证
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  subscriptions Subscription[]
  readHistory   ReadHistory[]
  bookmarks     Bookmark[]
  pushConfigs   PushConfig[]
  verificationCodes VerificationCode[]
}

// 验证码
model VerificationCode {
  id        String   @id @default(cuid())
  userId    String?
  email     String
  code      String
  type      String   // REGISTER, RESET_PASSWORD, EMAIL_CHANGE
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@index([email, type])
  @@index([code])
}

// 用户订阅源
model Subscription {
  id        String   @id @default(cuid())
  userId    String
  sourceId  String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  source    Source   @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  @@unique([userId, sourceId])
}

// 阅读历史
model ReadHistory {
  id        String   @id @default(cuid())
  userId    String
  articleId String
  readAt    DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  article   Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  @@unique([userId, articleId])
}

// 用户收藏
model Bookmark {
  id        String   @id @default(cuid())
  userId    String
  articleId String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  article   Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  @@unique([userId, articleId])
}

// 定时任务
model Task {
  id         String    @id @default(cuid())
  name       String
  type       String    // FETCH, SUMMARIZE, PUSH, CLEANUP
  schedule   String    // cron 表达式
  enabled    Boolean   @default(true)
  lastRun    DateTime?
  nextRun    DateTime?
  lastStatus String?
  lastError  String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  logs       TaskLog[]
}

// 任务执行日志
model TaskLog {
  id        String   @id @default(cuid())
  taskId    String
  status    String   // running, success, failed
  message   String?
  duration  Int?
  createdAt DateTime @default(now())
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
}

// 推送配置
model PushConfig {
  id       String  @id @default(cuid())
  userId   String
  type     String  // TELEGRAM, EMAIL, BARK
  target   String
  enabled  Boolean @default(true)
  schedule String  @default("08:00")
  user     User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@unique([userId, type])
}

// 每日统计
model DailyStat {
  id            String   @id @default(cuid())
  date          DateTime @unique
  articlesCount Int      @default(0)
  sourcesCount  Int      @default(0)
  usersCount    Int      @default(0)
  pushCount     Int      @default(0)
  createdAt     DateTime @default(now())
}
