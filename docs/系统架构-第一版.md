┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              控制平面 (Control Plane)                                    │
│                                  Next.js 应用层                                          │
│                                                                                         │
│   ┌───────────────────────────────────────────────────────────────────────────────┐    │
│   │  API Routes                    │  页面渲染                                     │    │
│   │  • /api/sources/[id]/fetch     │  • 信息源管理                                 │    │
│   │  • /api/articles               │  • 文章列表                                   │    │
│   │  • /api/admin/tasks            │  • 后台管理                                   │    │
│   └───────────────────────────────────────────────────────────────────────────────┘    │
│                                          │                                              │
│                                          │ 任务入队                                      │
│                                          ▼                                              │
│   ┌───────────────────────────────────────────────────────────────────────────────┐    │
│   │                           BullMQ 队列 (Redis)                                  │    │
│   │                                                                               │    │
│   │   newsflow-fetch ───► FetchWorker      (全文抓取)                              │    │
│   │   newsflow-summary ─► SummaryWorker    (AI 摘要)                               │    │
│   │   newsflow-credential► CredentialWorker (凭证刷新)                             │    │
│   └───────────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────────────┘
                                          │
                                          │ Worker 消费
                                          ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              调度层 (Scheduling Layer)                                   │
│                              Node Workers 进程                                           │
│                              scripts/start-workers.ts                                   │
│                                                                                         │
│   ┌───────────────────────────────────────────────────────────────────────────────┐    │
│   │                         DomainScheduler (内存单例)                             │    │
│   │                                                                               │    │
│   │   ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐              │    │
│   │   │ 并发控制        │  │ RPS 令牌桶      │  │ 熔断器          │              │    │
│   │   │                 │  │                 │  │                 │              │    │
│   │   │ medium.com: 2   │  │ medium.com: 1/s │  │ 阈值: 5次失败   │              │    │
│   │   │ twitter.com: 1  │  │ twitter.com:0.5 │  │ 熔断: 5分钟     │              │    │
│   │   │ 默认: 10        │  │ 默认: 10/s      │  │ 指数退避: 2^n秒 │              │    │
│   │   └─────────────────┘  └─────────────────┘  └─────────────────┘              │    │
│   └───────────────────────────────────────────────────────────────────────────────┘    │
│                                          │                                              │
│   ┌───────────────────────────────────────────────────────────────────────────────┐    │
│   │                              Workers 实现                                      │    │
│   │                                                                               │    │
│   │   FetchWorker ─────────────────────────────────────────────────────────────┐ │    │
│   │   │ 1. 检查熔断状态 (isCircuitOpen)                                        │ │    │
│   │   │ 2. 获取限流令牌 (acquireWithWait) ← 可能 sleep 等待                    │ │    │
│   │   │ 3. 获取凭证 (CredentialManager)                                        │ │    │
│   │   │ 4. 调用 UnifiedFetcher.fetch()                                         │ │    │
│   │   │ 5. 更新 Article 表                                                     │ │    │
│   │   │ 6. 反馈结果 (reportSuccess/reportFailure)                              │ │    │
│   │   │ 7. 推送 AI 摘要任务                                                    │ │    │
│   │   └────────────────────────────────────────────────────────────────────────┘ │    │
│   └───────────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────────────┘
                                          │
                                          │ UnifiedFetcher 策略路由
                                          ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              数据平面 (Data Plane)                                       │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │                           UnifiedFetcher (策略选择器)                            │  │
│   │                           src/lib/fetchers/unified-fetcher.ts                   │  │
│   │                                                                                 │  │
│   │   strategy: 'auto' ──┬──► Go Service 可用? ──► 是 ──► gRPC 调用                 │  │
│   │                      │                                                          │  │
│   │   strategy: 'go' ────┤                        └──► 否 ──► 降级 Local            │  │
│   │                      │                                                          │  │
│   │   strategy: 'browserless' ──► Browserless API                                   │  │
│   │                      │                                                          │  │
│   │   strategy: 'local' ─┴──► Node.js 本地抓取 (@mozilla/readability)               │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                          │                                              │
│          ┌───────────────────────────────┼───────────────────────────────┐              │
│          ▼                               ▼                               ▼              │
│   ┌─────────────────┐           ┌─────────────────┐           ┌─────────────────┐      │
│   │  ⚡ Go Scraper   │           │ 🌐 Browserless   │           │ 📦 Local Fetch  │      │
│   │  (gRPC)         │           │  (HTTP API)     │           │  (内置)         │      │
│   │                 │           │                 │           │                 │      │
│   │ • cycletls      │  降级     │ • 浏览器池       │           │ • node-fetch    │      │
│   │   TLS指纹伪造   │ ───────► │ • JS 渲染        │           │ • readability   │      │
│   │ • 连接池复用    │           │ • 资源拦截       │           │ • jsdom         │      │
│   │ • go-readability│           │ • 滚动加载       │           │                 │      │
│   │                 │           │                 │           │                 │      │
│   │ 内存: 128MB     │           │ 内存: 2GB       │           │ 内存: ~50MB     │      │
│   └────────┬────────┘           └────────┬────────┘           └────────┬────────┘      │
│            │                             │                             │                │
│            └─────────────────────────────┴─────────────────────────────┘                │
│                                          │                                              │
│                                          ▼                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │                              返回结构化数据                                      │  │
│   │   { title, content, textContent, imageUrl, author, publishedAt, fetchDuration } │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────────────┘
                                          │
                                          ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              存储层 (Storage Layer)                                      │
│                                                                                         │
│   ┌─────────────────┐           ┌─────────────────┐           ┌─────────────────┐      │
│   │  SQLite/PG      │           │  Redis          │           │  文件系统       │      │
│   │                 │           │                 │           │                 │      │
│   │ • Source        │           │ • BullMQ 队列   │           │ • 图片缓存      │      │
│   │ • Article       │           │ • 任务状态      │           │ • 临时文件      │      │
│   │ • User          │           │ • 配置重载通道  │           │                 │      │
│   │ • Credential    │           │                 │           │                 │      │
│   └─────────────────┘           └─────────────────┘           └─────────────────┘      │
└─────────────────────────────────────────────────────────────────────────────────────────┘

---

## 核心概念解释

### Scheduler vs Worker 的分工

```
┌─────────────────────────────────────────────────────────────────┐
│                        Scheduler（调度器）                        │
│                                                                 │
│   cron: "0 */2 * * *"  ──→  每2小时触发一次                       │
│   cron: "0 8 * * *"    ──→  每天8点触发一次                       │
└─────────────────────────────────────────────────────────────────┘
                                │
                                │ 触发时：往队列里加任务
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      BullMQ 队列（Redis）                        │
│                                                                 │
│   [任务1] [任务2] [任务3] [任务4] ...                             │
└─────────────────────────────────────────────────────────────────┘
                                │
                                │ Worker 取任务执行
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                        Worker（执行器）                          │
│                                                                 │
│   concurrency: 5  ──→  同时处理5个任务                           │
└─────────────────────────────────────────────────────────────────┘
```

| 组件 | 职责 | 代码位置 |
|------|------|---------|
| **Scheduler** | 定时触发，把任务**入队** | `src/lib/tasks/scheduler.ts` |
| **Worker** | 从队列**取任务并执行** | `src/lib/queue/workers.ts` |

**为什么这样设计？**
1. **解耦**：调度逻辑和执行逻辑分离
2. **削峰**：定时任务可能一次产生大量任务，队列可以平滑处理
3. **可靠性**：任务在 Redis 中持久化，进程重启不会丢失
4. **可观测**：可以看到队列中有多少待处理任务

---

### Worker Concurrency（并发数）

`concurrency` 是**单个 Worker 实例内部的并发能力**，不是多个 Worker 实例。

```
┌────────────────────────────────────────────┐
│              单个 Worker 进程               │
│                                            │
│   concurrency: 3                           │
│                                            │
│   ┌─────────┐ ┌─────────┐ ┌─────────┐     │
│   │ 任务 A  │ │ 任务 B  │ │ 任务 C  │     │
│   │ 处理中  │ │ 处理中  │ │ 处理中  │     │
│   └─────────┘ └─────────┘ └─────────┘     │
│         ↑           ↑           ↑          │
│         └───────────┴───────────┘          │
│              同时处理 3 个任务              │
└────────────────────────────────────────────┘
```

| 方式 | 说明 | 适用场景 |
|------|------|---------|
| **concurrency** | 单进程内并发（异步 I/O） | I/O 密集型任务（网络请求、数据库） |
| **多 Worker 实例** | 多进程/多服务器 | CPU 密集型、需要隔离、高可用 |

源抓取任务主要是 I/O 密集型（发 HTTP 请求、等待响应），所以用 concurrency 即可。

---

### Stalled 检测机制

Worker 配置中的锁和 stalled 检测是**容错机制**，用于处理 Worker 异常崩溃的情况。

```typescript
{
  // 任务锁超时：10分钟后自动释放锁
  lockDuration: 10 * 60 * 1000,
  // stalled 检查间隔：每30秒检查一次
  stalledInterval: 30 * 1000,
  // 最大 stalled 次数，超过则标记为失败
  maxStalledCount: 1
}
```

**场景说明：**

```
┌─────────────┐    获取任务+锁    ┌──────────────┐
│   Redis     │ ───────────────> │   Worker     │
│  (任务队列)  │                  │  (处理任务)   │
└─────────────┘                  └──────────────┘
                                        │
                                        ▼ Worker 崩溃了！
                                   ┌──────────┐
                                   │ 任务卡住  │
                                   └──────────┘
```

- **lockDuration**：Worker 处理任务时获取锁，防止其他 Worker 重复处理
- **stalledInterval**：定期检查是否有任务被获取但没有正常完成（Worker 可能崩溃了）
- **maxStalledCount**：任务 stalled 超过此次数后标记为失败，而不是无限重试

这确保了即使 Worker 进程异常退出（OOM、被杀、服务器重启），任务也不会永久卡住。
