# NewsFlow 开发日志 - 2026-02-02

## 测试脚本完善

### 修复的问题

1. **imgproxy 签名 URL** - 测试脚本原来用 `/insecure/` 路径，但实际 imgproxy 启用了签名验证。改用 `ImgproxyClient` 生成正确的签名 URL。

2. **Varnish 缓存不工作** - 两个问题：
   - VCL 规则只匹配 `/insecure/` 和 `/signature/`，不匹配签名 URL 格式 `/{signature}/...`
   - imgproxy 返回 `Cache-Control: private`，Varnish 拒绝缓存
   - 修复：VCL 中强制覆盖为 `public, max-age=604800`，设置 `beresp.uncacheable = false`

3. **gRPC 客户端 API** - 方法名是 `fetchArticle` 不是 `fetch`，添加了 `healthCheck` 测试

### 新增 npm scripts

```json
"test:scraper": "npx tsx scripts/test-scraper.ts",
"test:services": "npx tsx scripts/test-scraper.ts --services",
"test:fetch": "npx tsx scripts/test-scraper.ts --fetch",
"test:image": "npx tsx scripts/test-scraper.ts --image",
"test:grpc": "npx tsx scripts/test-scraper.ts --grpc",
"test:perf": "npx tsx scripts/test-scraper.ts --perf"
```

## 知乎抓取问题诊断

### 现象
- Go Scraper (CycleTLS) 返回 "HTTP error"
- Browserless 超时 (Navigation timeout)
- 直接 curl 返回 **403 Forbidden**
- 用户浏览器可以正常访问

### 根因
知乎的反爬策略非常严格：
1. **IP 检测** - 识别云服务器/数据中心 IP，拒绝访问
2. **Cookie 检测** - 未登录用户访问受限
3. **指纹检测** - 可能检测 TLS 指纹之外的其他特征

### 解决方案
1. **Cookie 认证** - 使用已实现的 `SiteCredential` 功能，添加登录后的 Cookie
2. **代理 IP** - 在 Go Scraper 中配置住宅代理
3. **域名配置** - 标记 `zhihu.com` 需要特殊处理

### 结论
架构设计正确（已包含 Cookie 认证支持），只是测试时没有提供有效凭证。

## 测试用例调整

移除知乎（需要登录），新增 V2EX（抓取友好）：
- example.com ✅
- Hacker News ✅
- GitHub ✅
- V2EX ✅ (28144 字符，cycletls)
- 36kr 快讯 ✅
- 36kr 文章 ✅

## 服务状态

所有服务正常：
- Go Scraper: CycleTLS 启用，100 并发
- imgproxy: 签名验证启用
- Varnish: 缓存正常 (MISS → HIT)
- Browserless: 5 并发
- Redis: 正常
